var show_list,lfm_route=location.origin+location.pathname,sort_type="alphabetic",multi_selection_enabled=!1,selected=[],items=[];function toggleMobileTree(e){void 0===e&&(e=!$("#tree").hasClass("in")),$("#tree").toggleClass("in",e)}function toggleSelected(e){multi_selection_enabled||(selected=[]);var t=$(e.target).closest("a").data("id"),n=selected.indexOf(t);-1===n?selected.push(t):selected.splice(n,1),updateSelectedStyle()}function clearSelected(){selected=[],multi_selection_enabled=!1,updateSelectedStyle()}function updateSelectedStyle(){items.forEach(function(e,t){$("[data-id="+t+"]").find(".square").toggleClass("selected",selected.indexOf(t)>-1)}),toggleActions()}function getOneSelectedElement(e){return items[void 0!==e?e:selected[0]]}function getSelectedItems(){return selected.reduce(function(e,t){return e.push(getOneSelectedElement(t)),e},[])}function toggleActions(){var e=1===selected.length,t=selected.length>=1,n=0===getSelectedItems().filter(function(e){return!e.is_image}).length,a=0===getSelectedItems().filter(function(e){return!e.is_file}).length;$("[data-action=use]").toggleClass("d-none",!(t&&a)),$("[data-action=rename]").toggleClass("d-none",!e),$("[data-action=preview]").toggleClass("d-none",!(t&&a)),$("[data-action=move]").toggleClass("d-none",!t),$("[data-action=download]").toggleClass("d-none",!(t&&a)),$("[data-action=resize]").toggleClass("d-none",!(e&&n)),$("[data-action=crop]").toggleClass("d-none",!(e&&n)),$("[data-action=trash]").toggleClass("d-none",!t),$("[data-action=open]").toggleClass("d-none",!e||a),$("#multi_selection_toggle").toggleClass("d-none",usingWysiwygEditor()||!t),$("#actions").toggleClass("d-none",0===selected.length),$("#fab").toggleClass("d-none",0!==selected.length)}function goTo(e){$("#working_dir").val(e),loadItems()}function getPreviousDir(){var e=$("#working_dir").val();return e.substring(0,e.lastIndexOf("/"))}function setOpenFolders(){$("#tree [data-path]").each(function(e,t){var n=($("#working_dir").val()+"/").startsWith($(t).data("path")+"/");$(t).children("i").toggleClass("fa-folder-open",n).toggleClass("fa-folder",!n)}),$("#tree .nav-item").removeClass("active"),$('#tree [data-path="'+$("#working_dir").val()+'"]').parent(".nav-item").addClass("active")}function performLfmRequest(e,t,n){var a=defaultParameters();return null!=t&&$.each(t,function(e,t){a[e]=t}),$.ajax({type:"GET",beforeSend:function(e){var t=getUrlParam("token");null!==t&&e.setRequestHeader("Authorization","Bearer "+t)},dataType:n||"text",url:lfm_route+"/"+e,data:a,cache:!1}).fail(function(e,t,n){displayErrorResponse(e)})}function displayErrorResponse(e){notify('<div style="max-height:50vh;overflow: scroll;">'+e.responseText+"</div>")}$.fn.fab=function(e){var t=this;t.addClass("fab-wrapper");var n=$("<a>").addClass("fab-button fab-toggle").append($("<i>").addClass("fas fa-plus")).click(function(){t.toggleClass("fab-expand")});t.append(n),e.buttons.forEach(function(e){n.before($("<a>").addClass("fab-button fab-action").attr("data-label",e.label).attr("id",e.attrs.id).append($("<i>").addClass(e.icon)).click(function(){t.removeClass("fab-expand")}))})},$(document).ready(function(){$("#fab").fab({buttons:[{icon:"fas fa-upload",label:lang["nav-upload"],attrs:{id:"upload"}},{icon:"fas fa-folder",label:lang["nav-new"],attrs:{id:"add-folder"}}]}),actions.reverse().forEach(function(e){$("#nav-buttons > ul").prepend($("<li>").addClass("nav-item").append($("<a>").addClass("nav-link d-none").attr("data-action",e.name).attr("data-multiple",e.multiple).append($("<i>").addClass("fas fa-fw fa-"+e.icon)).append($("<span>").text(e.label))))}),sortings.forEach(function(e){$("#nav-buttons .dropdown-menu").append($("<a>").addClass("dropdown-item").attr("data-sortby",e.by).append($("<i>").addClass("fas fa-fw fa-"+e.icon)).append($("<span>").text(e.label)).click(function(){sort_type=e.by,loadItems()}))}),loadFolders(),performLfmRequest("errors").done(function(e){JSON.parse(e).forEach(function(e){$("#alerts").append($("<div>").addClass("alert alert-warning").append($("<i>").addClass("fas fa-exclamation-circle")).append(" "+e))})}),$(window).on("dragenter",function(){$("#uploadModal").modal("show")}),usingWysiwygEditor()&&$("#multi_selection_toggle").hide()}),$("#multi_selection_toggle").click(function(){multi_selection_enabled=!multi_selection_enabled,$("#multi_selection_toggle i").toggleClass("fa-times",multi_selection_enabled).toggleClass("fa-check-double",!multi_selection_enabled),multi_selection_enabled||clearSelected()}),$("#to-previous").click(function(){var e=getPreviousDir();""!=e&&goTo(e)}),$("#show_tree").click(function(e){toggleMobileTree()}),$("#main").click(function(e){$("#tree").hasClass("in")&&toggleMobileTree(!1)}),$(document).on("click","#add-folder",function(){dialog(lang["message-name"],"",createFolder)}),$(document).on("click","#upload",function(){$("#uploadModal").modal("show")}),$(document).on("click","[data-display]",function(){show_list=$(this).data("display"),loadItems()}),$(document).on("click","[data-action]",function(){window[$(this).data("action")]($(this).data("multiple")?getSelectedItems():getOneSelectedElement())}),$(document).on("click","#tree a",function(e){goTo($(e.target).closest("a").data("path")),toggleMobileTree(!1)});var refreshFoldersAndItems=function(e){loadFolders(),"OK"!=e&&notify(e=Array.isArray(e)?e.join("<br/>"):e)},hideNavAndShowEditor=function(e){$("#nav-buttons > ul").addClass("d-none"),$("#content").html(e),$("#pagination").removeClass("preserve_actions_space"),clearSelected()};function loadFolders(){performLfmRequest("folders",{},"html").done(function(e){$("#tree").html(e),loadItems()})}function generatePaginationHTML(e,t){var n,a='<li class="page-item"></li>',o='<a class="page-link"></a>',i=t.currentPage,l=t.totalPage,r=t.rangeStart,s=t.rangeEnd;if(null===t.pageRange){for(n=1;n<=l;n++){var d=$(a).attr("data-num",n).append($(o).html(n));n==i&&d.addClass("active"),e.append(d)}return}if(r<=3)for(n=1;n<r;n++){var d=$(a).attr("data-num",n).append($(o).html(n));n==i&&d.addClass("active"),e.append(d)}else{var d=$(a).attr("data-num",1).append($(o).html(1));e.append(d);var d=$(a).addClass("disabled").append($(o).html("..."));e.append(d)}for(n=r;n<=s;n++){var d=$(a).attr("data-num",n).append($(o).html(n));n==i&&d.addClass("active"),e.append(d)}if(s>=l-2)for(n=s+1;n<=l;n++){var d=$(a).attr("data-num",n).append($(o).html(n));e.append(d)}else{var d=$(a).addClass("disabled").append($(o).html("..."));e.append(d);var d=$(a).attr("data-num",l).append($(o).html(l));e.append(d)}}function createPagination(e){var t=$('<ul class="pagination" role="navigation"></ul>'),n=e.current_page,a=Math.ceil(e.total/e.per_page),o=n-5,i=n+5;i>a&&(i=a,o=(o=a-10)<1?1:o),o<=1&&(o=1,i=Math.min(11,a)),generatePaginationHTML(t,{totalPage:a,currentPage:n,pageRange:5,rangeStart:o,rangeEnd:i}),$("#pagination").append(t)}function loadItems(e){loading(!0),performLfmRequest("jsonitems",{show_list:show_list,sort_type:sort_type,page:e||1},"html").done(function(e){selected=[];var t=JSON.parse(e),n=t.working_dir,a=0!==(items=t.items).length,o=!!t.paginator;$("#empty").toggleClass("d-none",a),$("#content").html("").removeAttr("class"),$("#pagination").html("").removeAttr("class"),a&&($("#content").addClass(t.display),$("#pagination").addClass("preserve_actions_space"),items.forEach(function(e,t){var n=$("#item-template").clone().removeAttr("id class").attr("data-id",t).click(toggleSelected).dblclick(function(t){e.is_file?use(getSelectedItems()):goTo(e.url)});if(e.thumb_url)var a=$("<div>").css("background-image",'url("'+e.thumb_url+"?timestamp="+e.time+'")');else var o=$("<div>").addClass("ico"),a=$("<div>").addClass("mime-icon ico-"+e.icon).append(o);n.find(".square").append(a),n.find(".item_name").text(e.name),n.find("time").text(new Date(1e3*e.time).toLocaleString()),$("#content").append(n)})),o&&(createPagination(t.paginator),$("#pagination a").on("click",function(e){return e.preventDefault(),loadItems($(this).closest("li")[0].getAttribute("data-num")),!1})),$("#nav-buttons > ul").removeClass("d-none"),$("#working_dir").val(n),console.log("Current working_dir : "+n);var i=[],l=n.split("/").filter(function(e){return e});l.forEach(function(e,t){0===t?i.push($("[data-path='/"+e+"']").text()):i.push(e)}),$("#current_folder").text(i[i.length-1]),$("#breadcrumbs > ol").html(""),i.forEach(function(e,t){var n=$("<li>").addClass("breadcrumb-item").text(e);t===i.length-1?n.addClass("active").attr("aria-current","page"):n.click(function(){goTo("/"+l.slice(0,1+t).join("/"))}),$("#breadcrumbs > ol").append(n)});var r=""==getPreviousDir();$("#to-previous").toggleClass("d-none invisible-lg",r),$("#show_tree").toggleClass("d-none",!r).toggleClass("d-block",r),setOpenFolders(),loading(!1),toggleActions()})}function loading(e){$("#loading").toggleClass("d-none",!e)}function createFolder(e){performLfmRequest("newfolder",{name:e}).done(refreshFoldersAndItems)}function rename(e){dialog(lang["message-rename"],e.name,function(t){performLfmRequest("rename",{file:e.name,new_name:t}).done(refreshFoldersAndItems)})}function trash(e){notify(lang["message-delete"],function(){performLfmRequest("delete",{items:e.map(function(e){return e.name})}).done(refreshFoldersAndItems)})}function crop(e){performLfmRequest("crop",{img:e.name}).done(hideNavAndShowEditor)}function resize(e){performLfmRequest("resize",{img:e.name}).done(hideNavAndShowEditor)}function download(e){e.forEach(function(e,t){var n=defaultParameters();n.file=e.name;var a=getUrlParam("token");a&&(n.token=a),setTimeout(function(){location.href=lfm_route+"/download?"+$.param(n)},100*t)})}function open(e){goTo(e.url)}function preview(e){var t=$("#carouselTemplate").clone().attr("id","previewCarousel").removeClass("d-none"),n=t.find(".carousel-item").clone().removeClass("active"),a=t.find(".carousel-indicators > li").clone().removeClass("active");t.children(".carousel-inner").html(""),t.children(".carousel-indicators").html(""),t.children(".carousel-indicators,.carousel-control-prev,.carousel-control-next").toggle(e.length>1),e.forEach(function(e,o){var i=n.clone().addClass(0===o?"active":"");e.thumb_url?i.find(".carousel-image").css("background-image","url('"+e.url+"?timestamp="+e.time+"')"):i.find(".carousel-image").css("width","50vh").append($("<div>").addClass("mime-icon ico-"+e.icon)),i.find(".carousel-label").attr("target","_blank").attr("href",e.url).append(e.name).append($('<i class="fas fa-external-link-alt ml-2"></i>')),t.children(".carousel-inner").append(i);var l=a.clone().addClass(0===o?"active":"").attr("data-slide-to",o);t.children(".carousel-indicators").append(l)});var o=null;t.on("touchstart",function(e){var t=e.originalEvent;1==t.touches.length&&(o=t.touches[0].pageX)}).on("touchmove",function(e){var n=e.originalEvent;if(null!=o){var a=n.changedTouches[0].pageX;a-o>60?(o=null,t.carousel("prev")):o-a>60&&(o=null,t.carousel("next"))}}).on("touchend",function(){o=null}),notify(t)}function move(e){performLfmRequest("move",{items:e.map(function(e){return e.name})}).done(refreshFoldersAndItems)}function getUrlParam(e){var t=RegExp("(?:[?&]|&)"+e+"=([^&]+)","i"),n=window.location.search.match(t);return n&&n.length>1?n[1]:null}function use(e){var t,n,a,o=e[0].url,i=getUrlParam("callback"),l=!0;usingWysiwygEditor()?(function e(t){if(usingTinymce3()){var n=tinyMCEPopup.getWindowArg("window");n.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=t,void 0!==n.ImageDialog&&(n.ImageDialog.getImageData&&n.ImageDialog.getImageData(),n.ImageDialog.showPreviewImage&&n.ImageDialog.showPreviewImage(t)),tinyMCEPopup.close()}}(o),t=o,usingTinymce4AndColorbox()&&(parent.document.getElementById(getUrlParam("field_name")).value=t,void 0!==parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),void 0!==parent.$.fn.colorbox&&parent.$.fn.colorbox.close()),n=o,usingTinymce5()&&(parent.postMessage({mceAction:"insert",content:n}),parent.postMessage({mceAction:"close"})),a=o,usingCkeditor3()&&(window.opener?window.opener.CKEDITOR.tools.callFunction(getUrlParam("CKEditorFuncNum"),a):(parent.CKEDITOR.tools.callFunction(getUrlParam("CKEditorFuncNum"),a),parent.CKEDITOR.tools.callFunction(getUrlParam("CKEditorCleanUpFuncNum")))),function e(t){if(usingFckeditor2()){var n=data.Properties.Width,a=data.Properties.Height;window.opener.SetUrl(t,n,a)}}(o)):i&&window[i]?window[i](getSelectedItems()):i&&parent[i]?parent[i](getSelecteditems()):window.opener?window.opener.SetUrl(getSelectedItems()):l=!1,l?window.opener&&window.close():(console.log("window.opener not found"),window.open(o))}function usingTinymce3(){return!!window.tinyMCEPopup}function usingTinymce4AndColorbox(){return!!getUrlParam("field_name")}function usingTinymce5(){return!!getUrlParam("editor")}function usingCkeditor3(){return!!getUrlParam("CKEditor")||!!getUrlParam("CKEditorCleanUpFuncNum")}function usingFckeditor2(){return window.opener&&"undefined"!=typeof data&&""!=data.Properties.Width}function usingWysiwygEditor(){return usingTinymce3()||usingTinymce4AndColorbox()||usingTinymce5()||usingCkeditor3()||usingFckeditor2()}function defaultParameters(){return{working_dir:$("#working_dir").val(),type:$("#type").val()}}function notImp(){notify("Not yet implemented!")}function notify(e,t){$("#notify").find(".btn-primary").toggle(void 0!==t),$("#notify").find(".btn-primary").unbind().click(t),$("#notify").modal("show").find(".modal-body").html(e)}function dialog(e,t,n){$("#dialog").find("input").val(t),$("#dialog").on("shown.bs.modal",function(){$("#dialog").find("input").focus()}),$("#dialog").find(".btn-primary").unbind().click(function(e){n($("#dialog").find("input").val())}),$("#dialog").modal("show").find(".modal-title").text(e)}